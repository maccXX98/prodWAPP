const express=require("express"),{post:post}=require("axios"),{products:products,urls:urls,cities:cities,cityList:cityList}=require("./options"),{productMessage:productMessage,cityMessage:cityMessage,directPaymentMessage:directPaymentMessage,qrPaymentMessage:qrPaymentMessage}=require("./answers"),app=express();app.use(express.json()),app.get("/webhook",((e,s)=>{"subscribe"===e.query["hub.mode"]&&e.query["hub.verify_token"]===process.env.Token?s.status(200).send(e.query["hub.challenge"]):s.sendStatus(400)})),app.post("/webhook",(async(e,s)=>{const t=e.body.entry?.[0]?.changes?.[0]?.value;if(!t)return s.sendStatus(500);const a=t.messages?.[0]?.text?.body.replace(/\s/g,"")||"",r=t.contacts?.[0]?.wa_id||"",o=t.messages?.[0]?.referral?.source_url||"",c=t.messages?.[0]?.interactive?.list_reply?.title||"",i=(t.messages?.[0]?.interactive,t.messages?.[0]?.button?.text?.toLowerCase()||""),n="método 1",p="método 2";let u,d=!1,g=Object.keys(products).find((e=>{let s=products[e].product;return urls[e].some((e=>o.includes(e)||a.includes(e)))||a.includes(s)}));g?(u=productMessage(r,products[g]),d=!0):cities.includes(c)?u=cityMessage(r,c):i!==n&&"1"!==a&&i!==p&&"2"!==a||(u=i===n||"1"===a?directPaymentMessage(r):qrPaymentMessage(r),i!==p&&"2"!==a||setTimeout((()=>{postMessage(directPaymentMessage(r))}),2e3));try{await postMessage(u),d&&setTimeout((async()=>{await postMessage(cityList(r))}),2e3),s.sendStatus(200)}catch(e){s.sendStatus(500)}}));const postMessage=async e=>await post(`https://graph.facebook.com/v18.0/${process.env.BotId}/messages`,e,{headers:{Authorization:`Bearer ${process.env.BearerToken}`,"Content-Type":"application/json"}});app.listen(process.env.PORT,(()=>{}));